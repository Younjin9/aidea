name: Backend CD

on:
  push:
    branches: [ "backend-integration" ]
    paths:
      - 'backend/**'
      - 'docker-compose.yml'

env:
  VERSION: ${{ github.sha }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Docker Image Name
        run: |
          echo "DOCKER_IMAGE=ghcr.io/$(echo ${{ github.actor }} | tr '[:upper:]' '[:lower:]')/aidea-backend" >> $GITHUB_ENV

      # 1. Java Setup & Build
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x backend/gradlew

      - name: Build with Gradle
        run: |
          cd backend
          ./gradlew clean build -x test

      # 2. Docker Build & Push to GHCR
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: ${{ env.DOCKER_IMAGE }}:latest,${{ env.DOCKER_IMAGE }}:${{ env.VERSION }}

      # 3. Deploy to EC2
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # Login to GHCR on EC2
            echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u $(echo ${{ github.actor }} | tr '[:upper:]' '[:lower:]') --password-stdin
            
            # Pull latest image
            docker pull ${{ env.DOCKER_IMAGE }}:latest
            
            # Create/Update docker-compose.yml on server
            cat > docker-compose.yml <<EOF
            services:
              mysql:
                image: mysql:8.0
                container_name: aidea-mysql
                restart: always
                ports:
                  - "3307:3306"
                environment:
                  MYSQL_ROOT_PASSWORD: ${{ secrets.DB_ROOT_PASSWORD }}
                  MYSQL_DATABASE: ${{ secrets.DB_NAME }}
                  MYSQL_USER: ${{ secrets.DB_USER }}
                  MYSQL_PASSWORD: ${{ secrets.DB_PASSWORD }}
                volumes:
                  - mysql_data:/var/lib/mysql
                command: >
                  --character-set-server=utf8mb4
                  --collation-server=utf8mb4_unicode_ci
                  --default-time-zone='+09:00'

              redis:
                image: redis:7-alpine
                container_name: aidea-redis
                restart: always
                ports:
                  - "6379:6379"
                volumes:
                  - redis-data:/data
                command: redis-server --appendonly yes

              backend:
                image: ${{ env.DOCKER_IMAGE }}:latest
                container_name: aidea-backend
                restart: always
                ports:
                  - "8080:8080"
                environment:
                  SPRING_PROFILES_ACTIVE: prod
                  DB_HOST: mysql
                  DB_NAME: ${{ secrets.DB_NAME }}
                  DB_USER: ${{ secrets.DB_USER }}
                  DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
                  REDIS_HOST: redis
                  JWT_SECRET: ${{ secrets.JWT_SECRET }}
                  KAKAO_CLIENT_ID: ${{ secrets.KAKAO_CLIENT_ID }}
                  KAKAO_CLIENT_SECRET: ${{ secrets.KAKAO_CLIENT_SECRET }}
                depends_on:
                  - mysql
                  - redis

            volumes:
              mysql_data:
              redis-data:
            EOF
            
            # Restart Services
            docker compose down
            docker compose up -d
            docker system prune -f
